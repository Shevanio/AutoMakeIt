# Agent Context Architecture

## Overview

This document explains how AutoMakeIt ensures AI agents have access to project architecture documentation when implementing features.

## Problem Statement

When agents implement features in AutoMakeIt, they need to be aware of:

- Existing architecture patterns
- Available components and services
- Technology stack in use
- Architectural constraints and best practices

Previously, `app_spec.txt` (generated by multi-agent analysis) was stored in `.automakeit/app_spec.txt` but **NOT** accessible to agents during feature implementation, since `loadContextFiles()` only reads from `.automakeit/context/`.

## Solution: Automatic Symlink

When the user saves `app_spec.txt`, the system automatically creates a symlink:

```
.automakeit/context/app_spec.txt → ../app_spec.txt
```

This symlink allows `loadContextFiles()` to include the architectural documentation in the agent's system prompt without code duplication.

## Architecture

### File Structure

```
.automakeit/
├── app_spec.txt              # Main architectural documentation (22KB)
├── improvements.md           # Improvement proposals (not synced)
└── context/                  # Agent context files
    ├── app_spec.txt          # Symlink → ../app_spec.txt
    ├── context-metadata.json # File descriptions
    └── *.md, *.txt           # Other context files
```

### Flow

1. **User saves spec** (via UI):

   ```typescript
   // apps/ui/src/components/views/spec-view/hooks/use-spec-save.ts
   await api.writeFile(`${currentProject.path}/.automakeit/app_spec.txt`, appSpec);
   ```

2. **Backend writes file** (via `/api/fs/write`):

   ```typescript
   // apps/server/src/routes/fs/routes/write.ts
   await secureFs.writeFile(filePath, content, 'utf-8');
   await createAppSpecSymlinkIfNeeded(filePath); // ← Auto-sync
   ```

3. **Symlink creation**:
   - Detects if filename is `app_spec.txt`
   - Extracts project path from `.automakeit/app_spec.txt`
   - Creates/updates symlink in `.automakeit/context/`
   - Updates `context-metadata.json` with description

4. **Agent loads context** (during feature implementation):

   ```typescript
   // apps/server/src/services/agent-service.ts:308
   const contextResult = await loadContextFiles({ projectPath });
   // Returns: { files: [{ name: 'app_spec.txt', content: '...', ... }], ... }
   ```

5. **Context added to prompt**:

   ```markdown
   # Project Context Files

   ## app_spec.txt

   **Path:** `.automakeit/context/app_spec.txt`
   **Purpose:** Project architecture documentation (auto-synced from multi-agent analysis)

   [Full 22KB spec content here...]
   ```

## Implementation Details

### `createAppSpecSymlinkIfNeeded()`

**Location**: `apps/server/src/routes/fs/routes/write.ts:19-78`

**Logic**:

1. Check if filename is `app_spec.txt`
2. Verify path contains `.automakeit` directory
3. Create context directory if needed
4. Remove old symlink (if exists)
5. Create new symlink (relative path: `../app_spec.txt`)
6. Update `context-metadata.json`

**Error Handling**:

- Non-blocking: If symlink creation fails, the write operation still succeeds
- Logs warning instead of throwing error

**Platform Compatibility**:

- Uses Node.js `fs.promises.symlink()` (supported on Windows, Linux, macOS since Node v10)
- Relative symlink path ensures portability

### Context Metadata

**File**: `.automakeit/context/context-metadata.json`

```json
{
  "files": {
    "app_spec.txt": {
      "description": "Project architecture documentation (auto-synced from multi-agent analysis)"
    }
  }
}
```

This metadata:

- Provides descriptions in the formatted prompt
- Helps users understand each context file's purpose
- Preserved across spec regenerations

## Benefits

### 1. **Architectural Consistency**

Agents implement features following documented patterns instead of inventing new ones.

### 2. **Component Reuse**

Agents are aware of existing components and services, reducing duplication.

### 3. **Zero Manual Effort**

Symlink creation is automatic—users never need to manually copy/sync files.

### 4. **No Code Duplication**

Single source of truth: `app_spec.txt` is the canonical document.

### 5. **Always Up-to-Date**

Every time the spec is saved (manual edit or regeneration), the symlink refreshes.

## Testing

### Manual Test

1. Save `app_spec.txt` from UI (Spec View → Save button)
2. Verify symlink exists:
   ```bash
   ls -la .automakeit/context/app_spec.txt
   # Output: lrwxrwxrwx ... app_spec.txt -> ../app_spec.txt
   ```
3. Verify it's readable:
   ```bash
   cat .automakeit/context/app_spec.txt | head -20
   ```
4. Create a feature and check agent logs for architecture references

### Automated Test

Run the test script:

```bash
node test-context-loader.mjs
```

**Expected output**:

```
✅ Loaded 1 context file(s):
1. app_spec.txt
   Description: Project architecture documentation (auto-synced from multi-agent analysis)
   Content size: 22412 bytes

✅ SUCCESS: app_spec.txt is loaded via symlink!
```

## Edge Cases

### Case 1: `app_spec.txt` doesn't exist

- Symlink creation skipped (function returns early)
- No error thrown

### Case 2: User manually deletes symlink

- Symlink recreated on next `app_spec.txt` save
- No impact on existing features

### Case 3: User edits `app_spec.txt` manually (via external editor)

- Symlink still valid (points to same file)
- Next UI save will refresh symlink

### Case 4: Symlink creation fails (permissions, etc.)

- Write operation still succeeds
- Warning logged: `"Failed to create app_spec.txt symlink"`
- Agent won't have context until symlink is fixed

### Case 5: Windows symlinks

- Node.js `fs.symlink()` works on Windows (may require admin on old systems)
- If symlink fails, users can manually copy file as fallback

## Future Enhancements

### 1. **Selective Context Loading**

Only load `app_spec.txt` for complex features (e.g., > 3 tasks) to save tokens on simple features.

### 2. **Context Summarization**

For very large specs (> 50KB), auto-generate a summary and load that instead.

### 3. **Context Versioning**

Track which spec version was used for each feature implementation.

### 4. **UI Indicator**

Show in Spec View whether `app_spec.txt` is synced to context.

## Related Files

- **Implementation**: `apps/server/src/routes/fs/routes/write.ts`
- **Context Loader**: `libs/utils/src/context-loader.ts`
- **Agent Service**: `apps/server/src/services/agent-service.ts`
- **Auto-Mode Service**: `apps/server/src/services/auto-mode-service.ts`
- **Test Script**: `test-context-loader.mjs`
- **Multi-Agent Analysis**: `docs/MULTI_AGENT_IMPROVEMENTS_SEPARATION.md`

## FAQ

**Q: Why symlink instead of copying the file?**
A: Symlinks ensure single source of truth and auto-sync without duplication. Changes to `app_spec.txt` are immediately visible in `context/`.

**Q: What if my OS doesn't support symlinks?**
A: Node.js supports symlinks on all major platforms. If it fails, manually copy `app_spec.txt` to `context/` as a fallback.

**Q: Does this increase token usage?**
A: Yes, by ~5,000 tokens per agent execution. This is acceptable given the value of architectural context.

**Q: Why isn't `improvements.md` also symlinked?**
A: `improvements.md` contains future proposals, not current architecture. Agents should implement features based on current state, not suggestions.

**Q: Can I add other files to context/?**
A: Yes! Any `.md` or `.txt` file in `.automakeit/context/` is automatically loaded. Examples:

- `CODE_QUALITY.md` - Coding standards
- `SECURITY_RULES.md` - Security requirements
- `API_CONVENTIONS.md` - API design patterns

---

**Document Version**: 1.0  
**Last Updated**: 2026-01-02  
**Author**: AutoMakeIt Team
